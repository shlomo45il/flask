# אינטגרציה בין שירותי המערכת ופתרון בעיית ההתחברות

מסמך זה מכיל הנחיות ותובנות לגבי האינטגרציה בין שירותי המערכת המודולרית, עם התמקדות בפתרון בעיית ההתחברות דרך שרת ה-Gateway.

## בעיות אפשריות בתהליך ההתחברות

1. **חוסר התאמה בפורמט ה-JSON**:
   - הפרונטאנד שולח או מצפה לפורמט JSON מסוים, אך השרת מחזיר פורמט אחר.
   - הבעיה עלולה להיות בכיוונים:
     - הפרונטאנד → Gateway → שרת האימות (בקשה)
     - שרת האימות → Gateway → הפרונטאנד (תשובה)

2. **בעיות כותרות HTTP**:
   - חוסר התאמה בכותרות `Content-Type` ו-`Accept`
   - בעיות CORS בעבודה מול דפדפן
   - חוסר העברה נכון של כותרות בין שירותים

3. **בעיות בנתיבי API**:
   - אי-התאמה בין הנתיבים שהפרונטאנד שולח אליהם לבין הנתיבים שה-Gateway מעביר

4. **טיפול בתשובות ושגיאות**:
   - אי-התאמה בקודי התשובה (status codes)
   - חוסר עקביות בפורמט הודעות השגיאה

## פתרונות ותיקונים

### 1. תיקון פורמט ה-JSON בתשובות

#### בעיה:
שרת האימות יוצר תשובת JSON תקינה, אך ה-Gateway עלול לשנות את התשובה או לא להגדיר נכון את סוג התוכן.

#### פתרון:
1. **בצד שרת ה-Gateway**:
   - הוספת הגדרה מפורשת של `Content-Type: application/json` לתשובות
   - הוספת בדיקות תקינות JSON לפני החזרת התשובה

   ```rust
   // בפונקציית handle_auth_request בקובץ main.rs
   client_response.content_type("application/json");
   ```

2. **בצד הפרונטאנד**:
   - קריאת התשובה כטקסט תחילה ואז המרה ל-JSON
   - הוספת טיפול מפורט בשגיאות JSON

   ```javascript
   // בדף AuthPage.js
   const responseText = await response.text();
   try {
     const data = JSON.parse(responseText);
     // המשך עיבוד הנתונים
   } catch (e) {
     console.error('שגיאה בפענוח JSON:', e);
   }
   ```

### 2. תיקון כותרות HTTP

#### בעיה:
אי-התאמה בכותרות HTTP בין הפרונטאנד, ה-Gateway ושרת האימות.

#### פתרון:
1. **בצד הפרונטאנד**:
   - הגדרה מפורשת של `Content-Type` ו-`Accept`

   ```javascript
   fetch(`${apiUrl}/api/auth/login/`, {
     headers: {
       'Content-Type': 'application/json',
       'Accept': 'application/json'
     },
     // ...
   });
   ```

2. **בצד ה-Gateway**:
   - העברה נכונה של כותרות בין השירותים
   - הגדרת CORS נכונה

   ```rust
   // העתקת כותרות מהבקשה המקורית
   for (header_name, header_value) in req.headers() {
     if header_name != "host" {
       request_builder = request_builder.header(header_name.clone(), header_value.clone());
     }
   }
   ```

### 3. תיקון נתיבי API

#### בעיה:
הפרונטאנד שולח בקשה לנתיב מסוים, אך ה-Gateway לא מעביר אותה לנתיב הנכון בשרת האימות.

#### פתרון:
1. **בצד ה-Gateway**:
   - פירוק נכון של נתיבי API
   - הדפסות מפורטות של הנתיבים לדיבוג

   ```rust
   // טיפול בנתיבים עם הקידומת /api
   let path_without_prefix = if path.starts_with(&format!("/api/{}", service_name)) {
     let prefix = format!("/api/{}", service_name);
     println!("Stripping prefix: {}", prefix);
     path.strip_prefix(&prefix).unwrap_or("")
   } else {
     // ...
   };
   ```

2. **בצד הפרונטאנד**:
   - שימוש בנתיבים עקביים

   ```javascript
   const apiUrl = process.env.REACT_APP_API_URL || 'http://localhost:8001';
   fetch(`${apiUrl}/api/auth/login/`, { /* ... */ });
   ```

## תובנות מהבדיקות

### תובנות על בעיית ההתחברות

1. **הסיבה העיקרית לבעיה**:
   - חוסר התאמה בטיפול ב-JSON בין השירותים השונים
   - ה-Gateway לא הגדיר נכון את כותרת ה-Content-Type בתשובות, מה שגרם לפרונטאנד לנסות לפענח את התשובה כסוג תוכן אחר

2. **תכונות מערכת שתרמו לבעיה**:
   - ארכיטקטורה מודולרית עם תקשורת בין שירותים
   - שימוש בטכנולוגיות שונות (Rust, Django, React) עם גישות שונות לטיפול ב-JSON
   - דרישה שכל התקשורת תעבור דרך ה-Gateway

### תובנות על בדיקות אינטגרציה

1. **חשיבות בדיקות מקיפות**:
   - הבדיקות שיצרנו חשפו את הבעיות העיקריות במערכת
   - הבדיקות מכסות תרחישים שונים (התחברות ישירה, דרך ה-Gateway, עם כותרות שונות)

2. **יתרונות השימוש בדוקר לבדיקות**:
   - יכולת לדמות את סביבת הייצור
   - יכולת לבודד ולבדוק שירותים ספציפיים
   - יכולת לבדוק את האינטגרציה בין השירותים

## סיכום פתרון הבעיה

בעיית ההתחברות במערכת נפתרה על ידי:
1. תיקון הטיפול ב-JSON בשרת ה-Gateway, עם הגדרה מפורשת של כותרות Content-Type
2. שיפור הטיפול בתשובות JSON בצד הפרונטאנד
3. וידוא שנתיבי ה-API מועברים נכון בין השירותים השונים
4. הוספת לוגים מפורטים לדיבוג בכל שלבי התהליך

המערכת כעת מסוגלת לטפל נכון בתהליך ההתחברות, עם תמיכה מלאה בעיקרון המודולרי שבו כל התקשורת עוברת דרך שרת ה-Gateway. 