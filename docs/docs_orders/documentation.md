# מודול ניהול הזמנות - תיעוד מערכת

## מבנה כללי
המערכת מיישמת מודול ניהול הזמנות כחלק ממערכת מודולית לניהול עסק. מודול ההזמנות מתקשר עם שירותים אחרים כמו שירות הלקוחות, שירות הספקים ושירות המלאי.

## רכיבים מרכזיים
1. **מודל הזמנה** (`Order`): מגדיר את המבנה של הזמנות במערכת
2. **API להזמנות**: מאפשר יצירה, עדכון, מחיקה וקבלה של הזמנות

## הבחנה בין סוגי הזמנות
במערכת קיימים שני סוגי הזמנות עיקריים:
- **הזמנות לקוח** (`order_type='customer'`): הזמנות שמתקבלות מלקוחות העסק
- **הזמנות רכש** (`order_type='purchase'`): הזמנות שהעסק מבצע מול ספקים

## תהליכי הזמנה

### תהליך הזמנת לקוח
1. **יצירת הזמנה**: בדיקת הלקוח ובדיקת מלאי זמין
2. **חישוב סכומים**: חישוב סכום הזמנה, מע"מ, הנחות וסכום סופי
3. **עדכון סטטוס הזמנה**: אפשרות לעדכן את סטטוס ההזמנה (ממתינה, בתהליך, נשלחה, הושלמה, בוטלה)
4. **עדכון סטטוס תשלום**: אפשרות לעדכן את סטטוס התשלום (לא שולם, שולם חלקית, שולם)
5. **ביטול הזמנה**: מחיקת ההזמנה והחזרת המלאי

### תהליך הזמנת רכש
1. **יצירת הזמנת רכש**: הגדרת הספק והפריטים המוזמנים
2. **עדכון סטטוס הזמנה**: כאשר הזמנת רכש מושלמת (`status='completed'`), המלאי מתעדכן אוטומטית

## חיבורים למודולים אחרים
- **שירות לקוחות** (`customers_service`): בדיקת תקפות הלקוח בעת יצירת הזמנת לקוח
- **שירות ספקים** (`suppliers_service`): בדיקת תקפות הספק בעת יצירת הזמנת רכש
- **שירות מלאי** (`inventory_service`): בדיקת זמינות מלאי ועדכון המלאי בהתאם להזמנות

## סטטוסים אפשריים להזמנות
- **pending**: הזמנה חדשה שנוצרה ומחכה לטיפול
- **processing**: הזמנה בתהליך טיפול
- **shipped**: הזמנה נשלחה ללקוח (רלוונטי להזמנות לקוח)
- **completed**: הזמנה הושלמה
- **cancelled**: הזמנה בוטלה

## סטטוסים אפשריים לתשלום
- **unpaid**: התשלום עדיין לא בוצע
- **partially_paid**: התשלום בוצע חלקית
- **paid**: התשלום בוצע במלואו

## שדות מודל ההזמנה
- **id**: מזהה ייחודי של ההזמנה
- **order_number**: מספר הזמנה ייחודי למעקב
- **customer_id**: מזהה הלקוח (עבור הזמנות לקוח)
- **supplier_id**: מזהה הספק (עבור הזמנות רכש)
- **items**: רשימת פריטים בהזמנה (JSON)
- **total_amount**: סכום כולל של ההזמנה (לפני מע"מ והנחות)
- **tax_amount**: סכום המע"מ
- **discount_amount**: סכום ההנחה
- **final_amount**: הסכום הסופי לתשלום
- **status**: סטטוס ההזמנה
- **order_type**: סוג ההזמנה (לקוח או רכש)
- **payment_status**: סטטוס התשלום
- **shipping_address**: כתובת למשלוח (רלוונטי להזמנות לקוח)
- **shipping_method**: שיטת המשלוח
- **notes**: הערות
- **created_at**: תאריך יצירת ההזמנה
- **updated_at**: תאריך עדכון אחרון

## נקודות קצה של ה-API

### קבלת מידע על הזמנות
- `GET /api/orders`: קבלת כל ההזמנות עם אפשרות לסינון
  - ניתן לסנן לפי `order_type`, `status`, `customer_id`, `supplier_id`
- `GET /api/orders/<order_id>`: קבלת מידע על הזמנה ספציפית

### יצירת הזמנות
- `POST /api/orders/customer`: יצירת הזמנת לקוח חדשה
- `POST /api/orders/purchase`: יצירת הזמנת רכש חדשה

### עדכון הזמנות
- `PUT /api/orders/<order_id>/status`: עדכון סטטוס הזמנה
- `PUT /api/orders/<order_id>/payment`: עדכון סטטוס תשלום של הזמנה

### מחיקת הזמנות
- `DELETE /api/orders/<order_id>`: ביטול הזמנה

## דוגמאות שימוש

### יצירת הזמנת לקוח
```json
POST /api/orders/customer
{
  "customer_id": 123,
  "items": [
    {
      "product_id": 456,
      "quantity": 2
    },
    {
      "product_id": 789,
      "quantity": 1
    }
  ],
  "discount_amount": 50.0,
  "shipping_address": "רחוב הרצל 10, תל אביב",
  "shipping_method": "דואר שליחים",
  "notes": "נא להשאיר אצל השכן אם אין אף אחד בבית"
}
```

### יצירת הזמנת רכש
```json
POST /api/orders/purchase
{
  "supplier_id": 456,
  "items": [
    {
      "product_id": 123,
      "quantity": 10,
      "price": 15.50
    },
    {
      "product_id": 234,
      "quantity": 5,
      "price": 25.75
    }
  ],
  "tax_amount": 85.25,
  "notes": "דחוף, אנחנו צריכים את המשלוח עד סוף השבוע"
}
```

### עדכון סטטוס הזמנה
```json
PUT /api/orders/123/status
{
  "status": "completed"
}
```

### עדכון סטטוס תשלום
```json
PUT /api/orders/123/payment
{
  "payment_status": "paid"
}
```

## דגשים חשובים
- יש לוודא תמיד עדכון נכון של המלאי בעת יצירה וביטול של הזמנות
- בעת יצירת הזמנות חדשות יש לבדוק תקפות הלקוח/ספק ומלאי זמין
- שמירה על אמינות הנתונים בעת תקשורת בין שירותים שונים
- מספרי הזמנה נוצרים אוטומטית עם פורמט ייחודי שמאפשר לזהות בקלות את סוג ההזמנה (לקוח/רכש)
- כל פעולה משמעותית כוללת טיפול בשגיאות ושימוש במנגנון rollback במקרה של כשל

## פיתוחים עתידיים
1. הוספת מערכת התראות למשתמשים על סטטוס הזמנות
2. שילוב עם מערכת תשלומים אוטומטית
3. תמיכה בתהליכי משלוח והפצה מתקדמים
4. ניהול החזרות וזיכויים
5. דוחות וניתוח נתונים על הזמנות
6. מערכת לניהול הנחות ומבצעים 